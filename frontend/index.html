<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rostio - My Schedule</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <script src="js/toast.js"></script>
    <script src="js/form-validation.js"></script>
    <script src="js/conflict-detection.js"></script>
    <script src="js/search-filter.js"></script>
</head>
<body>
    <div class="container">
        <!-- Onboarding Screen -->
        <div id="onboarding-screen" class="screen">
            <div class="welcome-card">
                <h1><img src="images/rostio-logo-simple.svg" alt="Rostio" style="height: 60px; vertical-align: middle; margin-right: 20px;"> Welcome to Rostio</h1>
                <p class="welcome-text">Join your organization and manage your schedule effortlessly</p>

                <div class="onboarding-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <h3>Join an Organization</h3>
                        <p>Find your church, league, or team</p>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <h3>Set Your Availability</h3>
                        <p>Block off times when you're unavailable</p>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <h3>View Your Schedule</h3>
                        <p>See your assignments and export to calendar</p>
                    </div>
                </div>

                <button class="btn btn-primary btn-large" onclick="startOnboarding()">Get Started ‚Üí</button>
                <p class="help-text">Already have an account? <a href="#" onclick="showLogin(); return false;">Sign in</a></p>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen" class="screen hidden">
            <div class="form-container">
                <h2>Sign In</h2>
                <p class="subtitle">Welcome back! Sign in to access your schedule</p>

                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="login-email" placeholder="your@email.com" required autofocus>
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" required>
                    </div>

                    <div id="login-error" class="error-message hidden"></div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">Sign In ‚Üí</button>
                    </div>
                </form>

                <p class="help-text">Don't have an account? <a href="#" onclick="startOnboarding(); return false;">Sign up</a></p>
            </div>
        </div>

        <!-- Join Organization -->
        <div id="join-screen" class="screen hidden">
            <div class="form-container">
                <h2>Join Your Organization</h2>
                <p class="subtitle">First, let's find your organization</p>

                <div id="org-list" class="org-selection">
                    <div class="loading">Loading organizations...</div>
                </div>

                <div class="divider">
                    <span>or</span>
                </div>

                <button class="btn btn-secondary" onclick="showCreateOrg()">Create New Organization</button>

                <div id="create-org-section" class="hidden">
                    <h3>Create Your Organization</h3>
                    <form onsubmit="createAndJoinOrg(event)">
                        <input type="text" id="new-org-name" placeholder="Organization Name (e.g., Grace Community Church)" required>
                        <input type="text" id="new-org-region" placeholder="Location (optional)">
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create & Continue</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- User Profile Setup -->
        <div id="profile-screen" class="screen hidden">
            <div class="form-container">
                <h2>Tell Us About Yourself</h2>
                <p class="subtitle">This helps us assign you appropriately</p>

                <form onsubmit="createProfile(event)">
                    <input type="text" id="user-name" placeholder="Your Full Name" required>
                    <input type="email" id="user-email" placeholder="Email Address" required>
                    <input type="password" id="user-password" placeholder="Create Password (min 6 characters)" minlength="6" required>
                    <input type="tel" id="user-phone" placeholder="Phone Number (optional)">

                    <label>What roles can you help with?</label>
                    <div class="role-selector" id="role-selector">
                        <label class="role-option">
                            <input type="checkbox" value="volunteer"> Volunteer
                        </label>
                        <label class="role-option">
                            <input type="checkbox" value="leader"> Leader/Coordinator
                        </label>
                        <label class="role-option">
                            <input type="checkbox" value="musician"> Musician
                        </label>
                        <label class="role-option">
                            <input type="checkbox" value="tech"> Tech/AV
                        </label>
                        <label class="role-option">
                            <input type="checkbox" value="childcare"> Childcare
                        </label>
                        <label class="role-option">
                            <input type="checkbox" value="hospitality"> Hospitality
                        </label>
                        <label class="role-option admin-role">
                            <input type="checkbox" value="admin"> Administrator
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">Continue ‚Üí</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="screen hidden">
            <header class="app-header">
                <div class="header-content">
                    <div class="header-left">
                        <div class="logo-container" onclick="goToHome()" style="cursor: pointer;"><img src="images/rostio-logo-white.svg" alt="Rostio" class="header-logo"></div>
                        <div class="org-selector">
                            <select id="org-dropdown" onchange="switchOrganization()" style="display: none;">
                                <!-- Organizations will be loaded here -->
                            </select>
                            <span id="org-name-display" class="org-badge"></span>
                        </div>
                    </div>
                    <div class="user-info">
                        <span id="user-name-display"></span>
                        <button class="btn-icon" onclick="showSettings()">‚öôÔ∏è</button>
                    </div>
                </div>
            </header>

            <!-- Quick Profile & Context Panel -->
            <div class="profile-context-panel">
                <div class="context-card">
                    <div class="context-header">
                        <h3>üìç Your Context</h3>
                        <button class="btn-link" onclick="showSettings()">Edit Profile ‚Üí</button>
                    </div>

                    <div class="context-grid">
                        <!-- Organization Section -->
                        <div class="context-item">
                            <label class="context-label">Organization</label>
                            <select id="org-dropdown-visible" onchange="switchOrganization()" class="org-select">
                                <option value="">Loading...</option>
                            </select>
                            <p class="context-help">Your current organization</p>
                        </div>

                        <!-- Roles Section -->
                        <div class="context-item">
                            <label class="context-label">Your Active Roles</label>
                            <div id="active-roles-display" class="role-badges">
                                <span class="role-badge">volunteer</span>
                            </div>
                            <button class="btn-link btn-sm" onclick="showSettings()">+ Add/Edit Roles</button>
                            <p class="context-help">These determine which events you'll be scheduled for</p>
                        </div>

                        <!-- Quick Actions -->
                        <div class="context-item">
                            <label class="context-label">Quick Actions</label>
                            <div class="quick-actions">
                                <button class="btn btn-sm btn-secondary" onclick="switchView('availability')">
                                    ‚è∞ Set Availability
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="exportMyCalendar()">
                                    üì• Export Calendar
                                </button>
                            </div>
                            <p class="context-help">Manage your schedule preferences</p>
                        </div>
                    </div>

                    <!-- First-time user hint -->
                    <div id="setup-hint" class="setup-hint hidden">
                        <div class="hint-content">
                            <span class="hint-icon">üí°</span>
                            <div>
                                <strong>New here?</strong> Make sure to:
                                <ol>
                                    <li>Select your roles above</li>
                                    <li>Set your availability (click "Set Availability")</li>
                                    <li>Check your upcoming schedule</li>
                                </ol>
                            </div>
                            <button class="btn-close" onclick="dismissSetupHint()">√ó</button>
                        </div>
                    </div>
                </div>
            </div>

            <nav class="main-nav">
                <button class="nav-btn active" data-view="schedule" onclick="switchView('schedule')">
                    üìÖ My Schedule
                </button>
                <button class="nav-btn" data-view="events" onclick="switchView('events')">
                    üìÜ All Events
                </button>
                <button class="nav-btn" data-view="availability" onclick="switchView('availability')">
                    ‚è∞ Availability
                </button>
                <button class="nav-btn admin-only hidden" data-view="admin" onclick="switchView('admin')">
                    üëë Admin Dashboard
                </button>
            </nav>

            <!-- My Schedule View -->
            <div id="schedule-view" class="view-content active">
                <div class="view-header">
                    <h2>My Schedule</h2>
                    <div class="schedule-controls">
                        <div class="schedule-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="upcoming-count">0</div>
                                <div class="stat-label">Upcoming</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="this-month-count">0</div>
                                <div class="stat-label">This Month</div>
                            </div>
                        </div>
                        <div class="schedule-actions">
                            <button class="btn btn-secondary" onclick="showCalendarSubscription()">üîó Subscribe</button>
                            <button class="btn btn-primary" onclick="exportMyCalendar()">üì• Export ICS</button>
                        </div>
                    </div>
                </div>

                <div id="schedule-list" class="schedule-timeline">
                    <div class="loading">Loading your schedule...</div>
                </div>
            </div>

            <!-- All Events View -->
            <div id="events-view" class="view-content">
                <div class="view-header">
                    <h2>All Organization Events</h2>
                    <p class="help-text">See all upcoming events and who's scheduled</p>
                </div>

                <div class="events-filter">
                    <select id="events-month-filter" onchange="loadAllEvents()">
                        <option value="current">This Month</option>
                        <option value="next">Next Month</option>
                        <option value="all">All Upcoming</option>
                    </select>
                </div>

                <div id="all-events-list" class="events-list">
                    <div class="loading">Loading events...</div>
                </div>
            </div>

            <!-- Availability View -->
            <div id="availability-view" class="view-content">
                <div class="view-header">
                    <h2>Set Your Availability</h2>
                    <p class="help-text">Block off times when you can't serve</p>
                </div>

                <div class="availability-form">
                    <h3>Add Time Off</h3>
                    <form onsubmit="addTimeOff(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="timeoff-start" required>
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="timeoff-end" required>
                            </div>
                        </div>
                        <input type="text" id="timeoff-reason" placeholder="Reason (optional, e.g., Vacation, Family event)">
                        <button type="submit" class="btn btn-primary">Add Time Off</button>
                    </form>

                    <div id="timeoff-list" class="timeoff-list">
                        <h3>Your Blocked Dates</h3>
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Edit Time Off Modal -->
            <div id="edit-timeoff-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Blocked Date</h3>
                        <button class="btn-close" onclick="closeEditTimeOffModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-timeoff-form" onsubmit="saveEditedTimeOff(event)">
                            <input type="hidden" id="edit-timeoff-id">
                            <div class="form-group">
                                <label>From Date</label>
                                <input type="date" id="edit-timeoff-start" required>
                            </div>
                            <div class="form-group">
                                <label>To Date</label>
                                <input type="date" id="edit-timeoff-end" required>
                            </div>
                            <div class="form-group">
                                <label>Reason (optional)</label>
                                <input type="text" id="edit-timeoff-reason" placeholder="e.g., Vacation, Family event">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeEditTimeOffModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-view" class="view-content">
                <div class="view-header">
                    <h2>Admin Console</h2>
                    <p class="help-text">Manage your organization</p>
                </div>

                <!-- Admin Tabs Navigation -->
                <div class="admin-tabs">
                    <button class="admin-tab-btn active" data-tab="events" onclick="switchAdminTab('events')">
                        Events
                    </button>
                    <button class="admin-tab-btn" data-tab="roles" onclick="switchAdminTab('roles')">
                        Roles
                    </button>
                    <button class="admin-tab-btn" data-tab="schedule" onclick="switchAdminTab('schedule')">
                        Schedule
                    </button>
                    <button class="admin-tab-btn" data-tab="people" onclick="switchAdminTab('people')">
                        People
                    </button>
                    <button class="admin-tab-btn" data-tab="reports" onclick="switchAdminTab('reports')">
                        Reports
                    </button>
                </div>

                <div class="admin-dashboard">
                    <!-- Events Tab -->
                    <div id="admin-tab-events" class="admin-tab-content active">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>Event Management</h3>
                                <div class="admin-controls">
                                    <button class="btn btn-primary" onclick="showCreateEventForm()">+ Create Event</button>
                                    <button class="btn btn-secondary" onclick="loadAdminEvents()">üîÑ Refresh</button>
                                </div>
                            </div>
                            <div class="admin-stats-inline">
                                <div class="stat-card-inline">
                                    <span class="stat-label-inline">Total Events:</span>
                                    <span class="stat-value-inline" id="admin-events-count">0</span>
                                </div>
                            </div>
                            <div id="admin-events-list" class="admin-list">
                                <div class="loading">Loading events...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Roles Tab -->
                    <div id="admin-tab-roles" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>Role Management</h3>
                                <div class="admin-controls">
                                    <button class="btn btn-primary" onclick="showAddRoleForm()">+ Add Role</button>
                                </div>
                            </div>
                            <p class="help-text">Define custom roles for your organization</p>
                            <div id="admin-roles-list" class="roles-list">
                                <div class="loading">Loading roles...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Tab -->
                    <div id="admin-tab-schedule" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>Schedule Generation</h3>
                            </div>
                            <div class="solver-controls">
                                <button class="btn btn-primary btn-large" onclick="generateSchedule()">
                                    üîÑ Generate Schedule
                                </button>
                                <p class="help-text">This will create assignments for all upcoming events</p>
                            </div>
                            <div id="solver-status" class="solver-status"></div>

                            <!-- Calendar View -->
                            <div class="admin-calendar-section">
                                <h4>Schedule Calendar</h4>
                                <div id="admin-calendar-view" class="admin-calendar">
                                    <div class="loading">Generate a schedule to see the calendar</div>
                                </div>
                            </div>
                        </div>

                        <!-- Generated Schedules List -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>Generated Schedules</h3>
                            </div>
                            <div class="admin-stats-inline">
                                <div class="stat-card-inline">
                                    <span class="stat-label-inline">Total Schedules:</span>
                                    <span class="stat-value-inline" id="admin-solutions-count">0</span>
                                </div>
                            </div>
                            <div id="admin-solutions-list" class="admin-list">
                                <div class="loading">Loading schedules...</div>
                            </div>
                        </div>
                    </div>

                    <!-- People Tab -->
                    <div id="admin-tab-people" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>People & Invitations</h3>
                                <div class="admin-controls">
                                    <button class="btn btn-primary" onclick="showInviteUserModal()">+ Invite User</button>
                                </div>
                            </div>
                            <div class="admin-stats-inline">
                                <div class="stat-card-inline">
                                    <span class="stat-label-inline">Total People:</span>
                                    <span class="stat-value-inline" id="admin-people-count">0</span>
                                </div>
                            </div>

                            <!-- Invitation Status Dashboard -->
                            <div class="invitations-dashboard">
                                <h4>Invitation Status</h4>
                                <div id="invitations-summary" class="invitations-summary">
                                    <div class="invitation-stat">
                                        <span class="invitation-count" id="pending-invitations">0</span>
                                        <span class="invitation-label">Pending</span>
                                    </div>
                                    <div class="invitation-stat">
                                        <span class="invitation-count" id="accepted-invitations">0</span>
                                        <span class="invitation-label">Accepted</span>
                                    </div>
                                    <div class="invitation-stat">
                                        <span class="invitation-count" id="expired-invitations">0</span>
                                        <span class="invitation-label">Expired</span>
                                    </div>
                                </div>
                                <div id="invitations-list" class="invitations-list">
                                    <div class="loading">Loading invitations...</div>
                                </div>
                            </div>

                            <!-- People List -->
                            <h4>Team Members</h4>
                            <div id="admin-people-list" class="admin-list">
                                <div class="loading">Loading people...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div id="admin-tab-reports" class="admin-tab-content">
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <h3>Reports & Export</h3>
                            </div>
                            <p class="help-text">Export schedules and generate reports</p>

                            <div class="reports-grid">
                                <div class="report-card">
                                    <h4>PDF Schedule Export</h4>
                                    <p>Download a printable schedule for distribution</p>
                                    <button class="btn btn-primary" onclick="exportLatestSchedulePDF()">üì• Export PDF</button>
                                </div>
                                <div class="report-card">
                                    <h4>Calendar Export (ICS)</h4>
                                    <p>Export all organization events to calendar</p>
                                    <button class="btn btn-primary" onclick="exportOrgCalendar()">üìÖ Export ICS</button>
                                </div>
                                <div class="report-card">
                                    <h4>Schedule Statistics</h4>
                                    <p>View assignment distribution and metrics</p>
                                    <button class="btn btn-secondary" onclick="showScheduleStats()">üìä View Stats</button>
                                </div>
                            </div>

                            <!-- Statistics Display -->
                            <div id="schedule-stats-display" class="stats-display hidden">
                                <h4>Schedule Statistics</h4>
                                <div id="stats-content" class="stats-content">
                                    <div class="loading">Loading statistics...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Event Modal -->
        <div id="create-event-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Create Event</h3>
                    <button class="btn-close" onclick="closeCreateEventForm()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="create-event-form" onsubmit="window.createEvent(event); return false;">
                        <div class="form-group">
                            <label>Event Type</label>
                            <select id="event-type" required>
                                <option value="">Select type...</option>
                                <option value="Sunday Service">Sunday Service</option>
                                <option value="Worship Service">Worship Service</option>
                                <option value="Bible Study">Bible Study</option>
                                <option value="Prayer Meeting">Prayer Meeting</option>
                                <option value="Youth Group">Youth Group</option>
                                <option value="Board Meeting">Board Meeting</option>
                                <option value="Special Event">Special Event</option>
                                <option value="Other">Other (specify in title)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Title (optional, override type name)</label>
                            <input type="text" id="event-title" placeholder="e.g., Christmas Service, Easter Celebration">
                        </div>
                        <div class="form-group">
                            <label>Date & Time</label>
                            <input type="datetime-local" id="event-start" required>
                        </div>
                        <div class="form-group">
                            <label>Duration (hours)</label>
                            <input type="number" id="event-duration" value="2" min="0.5" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Occurs</label>
                            <select id="event-occurs" onchange="toggleRecurrenceOptions()">
                                <option value="once">Once</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div id="recurrence-options" class="form-group" style="display: none;">
                            <label>End Date</label>
                            <input type="date" id="event-end-date">
                            <small style="color: var(--text-light); display: block; margin-top: 5px;">Leave blank for 1 year from start</small>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="event-location" placeholder="Main Sanctuary, Fellowship Hall">
                        </div>
                        <div class="form-group">
                            <label>Roles Needed - Select all that apply</label>
                            <div class="role-selector" id="event-role-selector">
                                <!-- Roles will be loaded dynamically from org config -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeCreateEventForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Event</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Settings</h3>
                    <button class="btn-close" onclick="closeSettings()">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="setting-item">
                        <label>Your Name</label>
                        <input type="text" id="settings-name" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Email</label>
                        <input type="email" id="settings-email" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Organization</label>
                        <input type="text" id="settings-org" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Timezone</label>
                        <select id="settings-timezone">
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">Eastern Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Los_Angeles">Pacific Time</option>
                            <option value="America/Anchorage">Alaska Time</option>
                            <option value="Pacific/Honolulu">Hawaii Time</option>
                            <option value="Europe/London">London</option>
                            <option value="Europe/Paris">Paris</option>
                            <option value="Asia/Tokyo">Tokyo</option>
                            <option value="Asia/Shanghai">Shanghai</option>
                            <option value="Asia/Dubai">Dubai</option>
                            <option value="Australia/Sydney">Sydney</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Roles - Select all that apply</label>
                        <div class="role-selector" id="settings-role-selector">
                            <label class="role-option">
                                <input type="checkbox" value="volunteer"> Volunteer
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="leader"> Leader/Coordinator
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="musician"> Musician
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="tech"> Tech/AV
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="childcare"> Childcare
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="hospitality"> Hospitality
                            </label>
                            <label class="role-option">
                                <input type="checkbox" value="admin"> Admin
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="logout()">Sign Out</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Role Modal -->
        <div id="add-role-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Add Custom Role</h3>
                    <button class="btn-close" onclick="closeAddRoleForm()">√ó</button>
                </div>
                <div class="modal-body">
                    <form onsubmit="addCustomRole(event)">
                        <div class="form-group">
                            <label>Role Name</label>
                            <input type="text" id="role-name" placeholder="e.g., Usher, Greeter, Sound Tech" required>
                        </div>
                        <div class="form-group">
                            <label>Description (optional)</label>
                            <textarea id="role-description" rows="3" placeholder="Brief description of this role"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddRoleForm()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Role</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Person Roles Modal -->
        <div id="edit-person-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Roles for <span id="edit-person-name"></span></h3>
                    <button class="btn-close" onclick="closeEditPersonModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="edit-person-form" onsubmit="updatePersonRoles(event)">
                        <input type="hidden" id="edit-person-id">
                        <div class="form-group">
                            <label>Roles</label>
                            <div id="edit-person-roles-checkboxes" class="role-selector">
                                <!-- Role checkboxes will be dynamically populated -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditPersonModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Role Modal -->
        <div id="edit-role-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Role</h3>
                    <button class="btn-close" onclick="closeEditRoleModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="edit-role-form" onsubmit="saveEditRole(event)">
                        <input type="hidden" id="edit-role-old-name">
                        <div class="form-group">
                            <label for="edit-role-name">Role Name</label>
                            <input type="text" id="edit-role-name" class="form-control" required>
                            <small class="form-help">Use lowercase with underscores (e.g., worship_leader)</small>
                        </div>
                        <div class="form-group">
                            <label for="edit-role-description">Description</label>
                            <textarea id="edit-role-description" class="form-control" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditRoleModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Manage Role People Modal -->
        <div id="manage-role-people-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Manage People for <span id="manage-role-name"></span></h3>
                    <button class="btn-close" onclick="closeManageRolePeopleModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="manage-role-people-form" onsubmit="saveRolePeople(event)">
                        <input type="hidden" id="manage-role-id">
                        <div class="form-group">
                            <label>Select people who should have this role:</label>
                            <div id="manage-role-people-checkboxes" class="role-selector">
                                <!-- People checkboxes will be dynamically populated -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeManageRolePeopleModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Assignment Modal -->
        <div id="assignment-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Assign People to Event</h3>
                    <button class="btn-close" onclick="closeAssignmentModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="assignment-people-list"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeAssignmentModal()">Done</button>
                </div>
            </div>
        </div>

        <!-- Invite User Modal -->
        <div id="invite-user-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Invite User</h3>
                    <button class="btn-close" onclick="closeInviteUserModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="invite-user-form" onsubmit="sendInvitation(event)">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="invite-email" placeholder="user@example.com" required>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="invite-name" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label>Assign Roles</label>
                            <div class="role-selector" id="invite-role-selector">
                                <label class="role-option">
                                    <input type="checkbox" value="volunteer"> Volunteer
                                </label>
                                <label class="role-option">
                                    <input type="checkbox" value="admin"> Admin
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeInviteUserModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Send Invitation</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Calendar Subscription Modal -->
        <div id="calendar-subscription-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Subscribe to Calendar</h3>
                    <button class="close-btn" onclick="closeCalendarSubscriptionModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">
                        Subscribe to your schedule in Google Calendar, Apple Calendar, Outlook, or any other calendar app.
                        Your calendar will automatically update when your schedule changes.
                    </p>

                    <div class="form-group">
                        <label>Subscription URL (webcal://)</label>
                        <div class="input-group">
                            <input type="text" id="webcal-url" readonly class="subscription-url">
                            <button class="btn btn-secondary" onclick="copyToClipboard('webcal-url')">Copy</button>
                        </div>
                        <small class="help-text">Use this URL in most calendar apps</small>
                    </div>

                    <div class="form-group">
                        <label>Alternative URL (https://)</label>
                        <div class="input-group">
                            <input type="text" id="https-url" readonly class="subscription-url">
                            <button class="btn btn-secondary" onclick="copyToClipboard('https-url')">Copy</button>
                        </div>
                        <small class="help-text">Use this if webcal:// doesn't work</small>
                    </div>

                    <div class="calendar-instructions">
                        <h4>How to subscribe:</h4>
                        <ul>
                            <li><strong>Google Calendar:</strong> Settings ‚Üí Add calendar ‚Üí From URL</li>
                            <li><strong>Apple Calendar:</strong> File ‚Üí New Calendar Subscription</li>
                            <li><strong>Outlook:</strong> Calendar ‚Üí Add calendar ‚Üí Subscribe from web</li>
                        </ul>
                    </div>

                    <div class="alert alert-warning">
                        <strong>Security Note:</strong> Keep this URL private. Anyone with this URL can view your schedule.
                        <button class="btn btn-link" onclick="resetCalendarToken()">Reset URL</button> if compromised.
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeCalendarSubscriptionModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Select Role for Event Modal -->
        <div id="select-role-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Select Your Role</h3>
                    <button class="btn-close" onclick="closeSelectRoleModal()">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">What role will you fulfill for this event?</p>
                    <form id="select-role-form" onsubmit="submitEventRole(event)">
                        <input type="hidden" id="role-event-id">
                        <div class="form-group">
                            <label for="event-role-select">Role</label>
                            <select id="event-role-select" class="form-control" required>
                                <option value="">-- Select a role --</option>
                                <option value="usher">Usher</option>
                                <option value="greeter">Greeter</option>
                                <option value="sound_tech">Sound Tech</option>
                                <option value="video_tech">Video Tech</option>
                                <option value="worship_leader">Worship Leader</option>
                                <option value="speaker">Speaker</option>
                                <option value="nursery">Nursery</option>
                                <option value="parking">Parking</option>
                                <option value="security">Security</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-role-group" style="display: none;">
                            <label for="custom-role-input">Custom Role Name</label>
                            <input type="text" id="custom-role-input" class="form-control" placeholder="Enter custom role">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeSelectRoleModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Join Event</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Timestamp-based cache busting
        const cacheBust = Date.now();
        document.write('<script src="js/role-management.js?t=' + cacheBust + '"><\/script>');
        document.write('<script src="js/edit-role-functions.js?t=' + cacheBust + '"><\/script>');
        document.write('<script src="js/recurring-events.js?t=' + cacheBust + '"><\/script>');
        document.write('<script src="js/app-user.js?t=' + cacheBust + '"><\/script>');
    </script>
</body>
</html>
